<!doctype html>
<html th:fragment="layout(title, links, scripts, content, subnav)" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="https://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title  th:text="#{app.title}"></title>
        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <link rel="icon" href="favicon.ico" type="image/x-icon" />

        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,600,700,800" rel="stylesheet">
        
        <link rel="stylesheet" th:href="@{/plugins/bootstrap/dist/css/bootstrap.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/icon-kit/dist/css/iconkit.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/ionicons/dist/css/ionicons.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/perfect-scrollbar/css/perfect-scrollbar.css}">
        <link rel="stylesheet" th:href="@{/plugins/datatables.net-bs4/css/dataTables.bootstrap4.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/jvectormap/jquery-jvectormap.css}">
        <link rel="stylesheet" th:href="@{/plugins/tempusdominus-bootstrap-4/build/css/tempusdominus-bootstrap-4.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/weather-icons/css/weather-icons.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/c3/c3.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/owl.carousel/dist/assets/owl.carousel.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/owl.carousel/dist/assets/owl.theme.default.min.css}">
        <link rel="stylesheet" th:href="@{/dist/css/theme.min.css}">
        <link rel="stylesheet" th:href="@{/plugins/datatables.net-bs4/css/dataTables.bootstrap4.min.css}">
        
        <script th:src="@{/src/js/vendor/modernizr-2.8.3.min.js}"></script>
        
    </head>

    <body>
       

        <div class="wrapper">
            <!-- header start-->
			<div th:insert="fragments/header"></div>
				<!-- header end -->

            <div class="page-wrap">
				<!-- Sidebar end-->
			<div th:insert="fragments/sidebar-menu"></div>
				<!-- Sidebar end -->
                <div class="main-content">
  
                                  <div class="card">
                                    <div class="card-body">
										<div class="d-flex justify-content-center buttons-wrapper">
									    <button id="" class="btn btn-sm btn-info btn-rounded addNewRows">Extra Forms</button>
									  </div>
                                        <div class="dt-responsive">
                                            <table id="order-table"
                                                   class="table table-striped table-bordered nowrap settings-table">
                                                <thead>
                                                <tr>
													<!--<th>ID</th>-->
													<th th:text="#{odk.formid}"></th>
													<th th:text="#{odk.date}"></th>
													<th th:text="#{odk.forname}"></th>
													<th th:text="#{odk.desc}"></th>
													<th th:text="#{odk.min}"></th>
													<th th:text="#{odk.max}"></th>
													<th th:text="#{odk.gender}"></th>
													<th th:text="#{odk.enabled}"></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                                                                                        
                                               
                                            </tbody>
                                            </table>
                                            <button type="button" class="btn btn-success add-row">Add Extra Form</button>
										      <button type="button" class="btn btn-success save">Save</button>
										      <button type="button" class="btn btn-secondary refresh">Refresh</button>
                                        </div>
                                    </div>
                                </div>
  
                </div>


				<!--Footer-->
                <div th:insert="fragments/footer"></div>
                
            </div>
        </div>
        
       
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script>window.jQuery || document.write('<script th:src="@{/src/js/vendor/jquery-3.3.1.min.js}"><\/script>')</script>
        <script th:src="@{/plugins/popper.js/dist/umd/popper.min.js}"></script>
        <script th:src="@{/plugins/bootstrap/dist/js/bootstrap.min.js}"></script>
        <script th:src="@{/plugins/perfect-scrollbar/dist/perfect-scrollbar.min.js}"></script>
        <script th:src="@{/plugins/screenfull/dist/screenfull.js}"></script>
        <script th:src="@{/plugins/datatables.net/js/jquery.dataTables.min.js}"></script>
        <script th:src="@{/plugins/datatables.net-bs4/js/dataTables.bootstrap4.min.js}"></script>
        <script th:src="@{/plugins/datatables.net-responsive/js/dataTables.responsive.min.js}"></script>
        <script th:src="@{/plugins/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js}"></script>
        <script th:src="@{/plugins/jvectormap/jquery-jvectormap.min.js}"></script>
        <script th:src="@{/plugins/jvectormap/tests/assets/jquery-jvectormap-world-mill-en.js}"></script>
        <script th:src="@{/plugins/moment/moment.js}"></script>
        <script th:src="@{/plugins/tempusdominus-bootstrap-4/build/js/tempusdominus-bootstrap-4.min.js}"></script>
        <script th:src="@{/plugins/d3/dist/d3.min.js}"></script>
        <script th:src="@{/plugins/c3/c3.min.js}"></script>
        <script th:src="@{/js/tables.js}"></script>
        <script th:src="@{/js/widgets.js}"></script>
        <script th:src="@{/js/charts.js}"></script>
        <script th:src="@{/dist/js/theme.min.js}"></script>
        <script th:src="@{/js/dashboard.js}"></script>
        <script th:src="@{/js/datatables.js}"></script>
        
        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='https://www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X','auto');ga('send','pageview');
        </script>
        
<script>
    function logout() {
        document.getElementById('logoutForm').submit();
    }
</script>


<script th:inline="javascript">
    function toggleEditMode(odkId) {
        // Set editMode to true for the corresponding setting
        var row = document.getElementById('row-' + odkid);
        row.style.backgroundColor = '#e6f7ff'; // Highlight the row
    }

    function saveSetting(odkId) {
        // Send an AJAX request to save the setting to the server
        // Update the row and reset editMode to false
        var row = document.getElementById('row-' + odkid);
        row.style.backgroundColor = ''; // Reset the background color
    }
</script>

<script>
      function addRow(tbody, id, formID, insertDate, formName, formDesc, minAge, maxAge, gender, enabled, className) {
        var tr = $("<tr></tr>").attr("data-id", id);
        if (className) {
          tr.addClass(className);
        }
        tr.append($("<td></td>").append($('<input type="text" class="form-control" required>').val(formID)));
        tr.append($("<td></td>").append($('<input type="date" class="form-control" required>').val(insertDate)));
        tr.append($("<td></td>").append($('<input type="text" class="form-control" required>').val(formName)));
        tr.append($("<td></td>").append($('<input type="text" class="form-control" required>').val(formDesc)));
        tr.append($("<td></td>").append($('<input type="text" class="form-control" required>').val(minAge)));
        tr.append($("<td></td>").append($('<input type="text" class="form-control" required>').val(maxAge)));
        

    var selectGender = $('<select class="form-control"></select>');
	// Adding a default disabled option
	selectGender.append('<option value="" selected disabled>Select Option</option>');	
	// Fetching data from the API and populating the options
	$.getJSON("/api/codebook/gender", function (data) {
	    data.forEach(function (item) {
	        var option = $("<option></option>")
	            .attr("value", item.codeValue)
	            .text(item.codeLabel);
	        selectGender.append(option);
	    });	
	    // Setting the selected value (if available)
	    if (gender) {
	        selectGender.val(gender);
	    }
	});	
	tr.append($("<td></td>").append(selectGender));

	
	//Enabled
	var selectEnabled = $('<select class="form-control"></select>');
	// Adding a default disabled option
	selectEnabled.append('<option value="" selected disabled>Select Option</option>');	
	// Fetching data from the API and populating the options
	$.getJSON("/api/codebook/enabled", function (data) {
	    data.forEach(function (item) {
	        var option = $("<option></option>")
	            .attr("value", item.codeValue)
	            .text(item.codeLabel);
	        selectEnabled.append(option);
	    });	
	    // Setting the selected value (if available)
	    if (enabled) {
	        selectEnabled.val(enabled);
	    }
	});	
	tr.append($("<td></td>").append(selectEnabled));

        
        tbody.append(tr);
      }

      function tableRefresh() {
        var tbody = $(".settings-table tbody");
        tbody.html("Loading...");

        $.getJSON("/api/odk", function (data) {
          tbody.html("");
          data.forEach((el) => {
            addRow(tbody, el.id, el.formID, insertDate, el.formName, el.formDesc , el.minAge, el.maxAge, el.gender , el.enabled);
          });
        });
      }

      $("button.refresh").click(tableRefresh);

      $("button.add-row").click(function () {
        var tbody = $(".settings-table tbody");
        addRow(tbody, null, null, null, null, null, null, null, null,  null, "dirty");
      });

      $("button.save").click(function () {
        var arr = [];
        $(".settings-table tbody tr").each(function () {
          var row = $(this);
          if (row.hasClass("dirty") || row.hasClass("deleted")) {
            var rowData = { uuid: row.attr("data-id") };
            var keys = ["formID", "insertDate","formName", "formDesc" , "minAge", "maxAge", "gender" , "enabled"];

            row.find("input").each(function (idx) {
              rowData[keys[idx]] = $(this).val();
            });

            arr.push({
              action: row.hasClass("deleted") ? "DELETE" : "UPDATE",
              data: rowData,
            });
          }
        });

        $.ajax({
          type: "POST",
          url: '/api/odk',
          contentType: 'application/json',
          data: JSON.stringify(arr),
          success: tableRefresh,
          error: function(jqXHR, textStatus, errorThrown) {
            alert('error: ' + jqXHR.responseJSON.message);
          }
        });

      });

      $(document).on("click", "button.delete-row", function () {
        var row = $(this).closest("tr");
        if (row.attr("data-id")) {
          row.addClass("deleted");
        } else {
          row.remove();
        }
      });

      $(document).on("change", ".settings-table tbody input", function () {
        $(this).closest("tr").addClass("dirty");
      });

      tableRefresh();
    </script>

        
    </body>
</html>
